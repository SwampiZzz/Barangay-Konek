<?php
require_once __DIR__ . '/../config.php';
require_once __DIR__ . '/../middleware/auth.php';
require_once __DIR__ . '/../helpers/notifications.php';

require_login();

$complaint_id = intval($_GET['id'] ?? 0);
if ($complaint_id <= 0) {
    flash_set('Invalid complaint ID.', 'error');
    header('Location: index.php?nav=complaint-list');
    exit;
}

$user_id = current_user_id();
$user_role = current_user_role();
$barangay_id = current_user_barangay_id();

// Fetch complaint details
$stmt = $conn->prepare('
    SELECT c.*, cs.name as status_name, u.username, p.first_name, p.last_name
    FROM complaint c
    LEFT JOIN complaint_status cs ON c.complaint_status_id = cs.id
    LEFT JOIN users u ON c.user_id = u.id
    LEFT JOIN profile p ON u.id = p.user_id
    WHERE c.id = ?
');
if (!$stmt) die('DB prepare failed: ' . $conn->error);
$stmt->bind_param('i', $complaint_id);
$stmt->execute();
$res = $stmt->get_result();
$complaint = $res->fetch_assoc();
$stmt->close();

if (!$complaint) {
    flash_set('Complaint not found.', 'error');
    header('Location: index.php?nav=manage-complaints');
    exit;
}

// Access control
$is_owner = ($user_role === ROLE_USER && $complaint['user_id'] === $user_id);
$is_staff_or_admin = in_array($user_role, [ROLE_STAFF, ROLE_ADMIN]) && $complaint['barangay_id'] === $barangay_id;
$is_superadmin = $user_role === ROLE_SUPERADMIN;

if (!($is_owner || $is_staff_or_admin || $is_superadmin)) {
    flash_set('You do not have access to this complaint.', 'error');
    header('Location: index.php?nav=manage-complaints');
    exit;
}

// Handle status update actions
if ($_SERVER['REQUEST_METHOD'] === 'POST') {
    $action = $_POST['action'] ?? '';
    $status_id = intval($complaint['complaint_status_id']);
    
    // User delete complaint (only if open)
    if ($action === 'user_delete_complaint' && $is_owner && $status_id === 1) {
        $delete_stmt = $conn->prepare('UPDATE complaint SET deleted_at = NOW() WHERE id = ?');
        if ($delete_stmt) {
            $delete_stmt->bind_param('i', $complaint_id);
            if ($delete_stmt->execute()) {
                activity_log($user_id, 'Deleted complaint', 'complaint', $complaint_id);
                flash_set('Complaint deleted successfully.', 'success');
                header('Location: index.php?nav=manage-complaints');
                exit;
            } else {
                flash_set('Failed to delete complaint.', 'error');
            }
            $delete_stmt->close();
        }
    }
    
    // Check if complaint is closed (read-only)
    if ($status_id === 4) {
        flash_set('This complaint is closed and cannot be modified.', 'error');
    } elseif ($action === 'mark_in_progress' && in_array($user_role, [ROLE_STAFF, ROLE_ADMIN]) && $status_id === 1) {
        $update_stmt = $conn->prepare('UPDATE complaint SET complaint_status_id = 2, updated_at = NOW() WHERE id = ?');
        if ($update_stmt) {
            $update_stmt->bind_param('i', $complaint_id);
            if ($update_stmt->execute()) {
                activity_log($user_id, 'Marked complaint in progress', 'complaint', $complaint_id);
                notify_user($complaint['user_id'], 'Complaint Status Updated', 'Your complaint #' . str_pad($complaint_id, 5, '0', STR_PAD_LEFT) . ' is now in progress.');
                flash_set('Complaint marked as in progress.', 'success');
            } else {
                flash_set('Failed to update complaint status.', 'error');
            }
            $update_stmt->close();
        }
    } elseif ($action === 'mark_resolved' && in_array($user_role, [ROLE_STAFF, ROLE_ADMIN]) && $status_id === 2) {
        $remarks = trim($_POST['remarks'] ?? '');
        if (empty($remarks)) {
            flash_set('Please provide remarks for resolution.', 'error');
        } else {
            $update_stmt = $conn->prepare('UPDATE complaint SET complaint_status_id = 3, remarks = ?, updated_at = NOW() WHERE id = ?');
            if ($update_stmt) {
                $update_stmt->bind_param('si', $remarks, $complaint_id);
                if ($update_stmt->execute()) {
                    activity_log($user_id, 'Resolved complaint', 'complaint', $complaint_id);
                    notify_user($complaint['user_id'], 'Complaint Resolved', 'Your complaint #' . str_pad($complaint_id, 5, '0', STR_PAD_LEFT) . ' has been resolved.');
                    flash_set('Complaint marked as resolved.', 'success');
                } else {
                    flash_set('Failed to update complaint status.', 'error');
                }
                $update_stmt->close();
            }
        }
    } elseif ($action === 'confirm_resolution' && $user_role === ROLE_ADMIN && $status_id === 3) {
        $update_stmt = $conn->prepare('UPDATE complaint SET complaint_status_id = 4, updated_at = NOW() WHERE id = ?');
        if ($update_stmt) {
            $update_stmt->bind_param('i', $complaint_id);
            if ($update_stmt->execute()) {
                activity_log($user_id, 'Closed complaint', 'complaint', $complaint_id);
                notify_user($complaint['user_id'], 'Complaint Closed', 'Your complaint #' . str_pad($complaint_id, 5, '0', STR_PAD_LEFT) . ' has been closed.');
                flash_set('Complaint closed.', 'success');
            } else {
                flash_set('Failed to close complaint.', 'error');
            }
            $update_stmt->close();
        }
    } elseif ($action === 'reopen' && $user_role === ROLE_ADMIN && $status_id === 3) {
        $update_stmt = $conn->prepare('UPDATE complaint SET complaint_status_id = 2, updated_at = NOW() WHERE id = ?');
        if ($update_stmt) {
            $update_stmt->bind_param('i', $complaint_id);
            if ($update_stmt->execute()) {
                activity_log($user_id, 'Reopened complaint', 'complaint', $complaint_id);
                notify_user($complaint['user_id'], 'Complaint Reopened', 'Your complaint #' . str_pad($complaint_id, 5, '0', STR_PAD_LEFT) . ' has been reopened for further review.');
                flash_set('Complaint reopened and returned to staff.', 'success');
            } else {
                flash_set('Failed to reopen complaint.', 'error');
            }
            $update_stmt->close();
        }
    }
    
    // Refresh data
    if (flash_get('success')) {
        header('Location: index.php?nav=complaint-ticket&id=' . $complaint_id);
        exit;
    }
}

// Fetch attachments
$attachments = [];
$attach_stmt = $conn->prepare('SELECT * FROM complaint_attachment WHERE complaint_id = ? ORDER BY uploaded_at DESC');
if ($attach_stmt) {
    $attach_stmt->bind_param('i', $complaint_id);
    $attach_stmt->execute();
    $attach_res = $attach_stmt->get_result();
    while ($row = $attach_res->fetch_assoc()) {
        $attachments[] = $row;
    }
    $attach_stmt->close();
}

$status_id = intval($complaint['complaint_status_id']);
$pageTitle = 'Complaint #' . str_pad($complaint_id, 5, '0', STR_PAD_LEFT);
require_once __DIR__ . '/../public/header.php';
?>

<div class="container-fluid my-4 px-3 px-md-4">
    <div style="max-width: 1200px; margin-left: auto; margin-right: auto;">
        <!-- Header -->
        <div class="d-flex justify-content-between align-items-start mb-4">
            <div>
                <h2 class="mb-1"><i class="fas fa-exclamation-circle text-danger me-2"></i>Complaint #<?php echo str_pad($complaint_id, 5, '0', STR_PAD_LEFT); ?></h2>
                <p class="text-muted small mb-0">Submitted: <strong><?php echo date('M d, Y â€¢ h:i A', strtotime($complaint['created_at'])); ?></strong></p>
            </div>
            <a href="index.php?nav=manage-complaints" class="btn btn-outline-secondary btn-sm">
                <i class="fas fa-arrow-left me-1"></i>Back to List
            </a>
        </div>

        <!-- Flash Messages -->
        <?php 
        $flash = flash_get();
        if (!empty($flash['message'])): 
        ?>
            <div class="alert alert-<?php echo $flash['type'] === 'error' ? 'danger' : 'success'; ?> alert-dismissible fade show" role="alert" style="border-left: 4px solid; margin-bottom: 2rem;">
                <i class="fas fa-<?php echo $flash['type'] === 'error' ? 'exclamation-circle' : 'check-circle'; ?> me-2"></i>
                <?php echo e($flash['message']); ?>
                <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
            </div>
        <?php endif; ?>

        <div class="row g-4">
            <!-- Main Content -->
            <div class="col-lg-8">
                <!-- Status Card -->
                <div class="card border-0 shadow-sm mb-4">
                    <div class="card-body p-4">
                        <div class="d-flex align-items-center justify-content-between" style="flex-wrap: wrap; gap: 1rem;">
                            <div>
                                <small class="text-muted d-block mb-1" style="text-transform: uppercase; font-weight: 500; font-size: 0.75rem;">Current Status</small>
                                <h5 class="mb-0">
                                    <?php 
                                    $status_colors = [
                                        1 => 'danger',     // open
                                        2 => 'info',       // in_progress
                                        3 => 'warning',    // resolved
                                        4 => 'success'     // closed
                                    ];
                                    $status_icons = [
                                        1 => 'exclamation-circle',
                                        2 => 'hourglass-start',
                                        3 => 'check-circle',
                                        4 => 'lock'
                                    ];
                                    $color = $status_colors[$status_id] ?? 'secondary';
                                    $icon = $status_icons[$status_id] ?? 'question-circle';
                                    ?>
                                    <span class="badge bg-<?php echo $color; ?>" style="padding: 0.5rem 1rem; font-size: 0.95rem;">
                                        <i class="fas fa-<?php echo $icon; ?> me-2"></i><?php echo htmlspecialchars($complaint['status_name']); ?>
                                    </span>
                                </h5>
                            </div>
                            <div style="text-align: right;">
                                <small class="text-muted d-block mb-1">Submitter</small>
                                <div class="fw-600">
                                    <?php if ($complaint['is_anonymous'] && !in_array($user_role, [ROLE_STAFF, ROLE_ADMIN, ROLE_SUPERADMIN])): ?>
                                        <i class="fas fa-mask me-1"></i>Anonymous
                                    <?php else: ?>
                                        <?php echo htmlspecialchars($complaint['first_name'] . ' ' . $complaint['last_name']); ?>
                                    <?php endif; ?>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Complaint Details -->
                <div class="card border-0 shadow-sm mb-4">
                    <div class="card-header bg-light fw-600 py-3">
                        <i class="fas fa-align-left me-2"></i>Complaint Details
                    </div>
                    <div class="card-body p-4">
                        <h5 class="mb-3" style="color: #1f2937;"><?php echo htmlspecialchars($complaint['title']); ?></h5>
                        <div style="background: #f8f9fa; padding: 1.5rem; border-radius: 6px; border-left: 4px solid #dc3545;">
                            <?php echo nl2br(htmlspecialchars($complaint['description'])); ?>
                        </div>
                    </div>
                </div>

                <!-- Attachments -->
                <?php if (count($attachments) > 0): ?>
                <div class="card border-0 shadow-sm mb-4">
                    <div class="card-header bg-light fw-600 py-3">
                        <i class="fas fa-paperclip me-2"></i>Supporting Files (<?php echo count($attachments); ?>)
                    </div>
                    <div class="card-body p-4">
                        <div class="list-group list-group-flush">
                            <?php foreach ($attachments as $att): ?>
                                <div class="list-group-item px-0 py-3 d-flex justify-content-between align-items-center border-0 border-bottom">
                                    <div>
                                        <div class="fw-600">
                                            <i class="fas fa-file me-2" style="color: #6c757d;"></i><?php echo basename($att['file_path']); ?>
                                        </div>
                                        <small class="text-muted">Uploaded: <?php echo date('M d, Y \u2022 h:i A', strtotime($att['uploaded_at'])); ?></small>
                                    </div>
                                    <a href="<?php echo WEB_ROOT . '/' . $att['file_path']; ?>" target="_blank" class="btn btn-sm btn-outline-primary">
                                        <i class="fas fa-eye me-1"></i>View
                                    </a>
                                </div>
                            <?php endforeach; ?>
                        </div>
                    </div>
                </div>
                <?php endif; ?>

                <!-- Remarks/Resolution (if staff has added) -->
                <?php if ($status_id >= 3 && !empty($complaint['remarks'])): ?>
                <div class="card border-0 shadow-sm mb-4">
                    <div class="card-header bg-light fw-600 py-3">
                        <i class="fas fa-comment-dots me-2"></i>Staff Remarks / Resolution
                    </div>
                    <div class="card-body p-4">
                        <div style="background: #f0f8ff; padding: 1.5rem; border-radius: 6px; border-left: 4px solid #0dcaf0;">
                            <?php echo nl2br(htmlspecialchars($complaint['remarks'])); ?>
                        </div>
                    </div>
                </div>
                <?php endif; ?>
            </div>

            <!-- Actions Sidebar -->
            <div class="col-lg-4">
                <div class="card border-0 shadow-sm sticky-top" style="top: 20px;">
                    <div class="card-header bg-warning text-dark fw-600">
                        <i class="fas fa-tasks me-2"></i>Actions
                    </div>
                    <div class="card-body p-3">
                        <?php
                        $can_act = false;
                        
                        // Owner view (read-only, closed complaints)
                        if ($is_owner && $status_id === 4):
                            $can_act = true;
                        ?>
                            <div class="alert alert-success mb-3">
                                <i class="fas fa-lock me-2"></i>
                                <strong>Complaint Closed</strong>
                                <p class="mb-0 mt-2 small">This complaint has been closed and is read-only.</p>
                            </div>
                        <?php endif;
                        
                        // Owner view - pending or in progress
                        if ($is_owner && in_array($status_id, [1, 2])):
                            $can_act = true;
                        ?>
                            <div class="alert alert-info mb-3">
                                <i class="fas fa-hourglass-start me-2"></i>
                                <strong>In Review</strong>
                                <p class="mb-0 mt-2 small">Your complaint is being processed. You'll receive updates via notifications.</p>
                            </div>
                        <?php endif;
                        
                        // Owner view - resolved
                        if ($is_owner && $status_id === 3):
                            $can_act = true;
                        ?>
                            <div class="alert alert-success mb-3">
                                <i class="fas fa-check-circle me-2"></i>
                                <strong>Resolved</strong>
                                <p class="mb-0 mt-2 small">Your complaint has been resolved. Admin is reviewing for final closure.</p>
                            </div>
                        <?php endif;
                        
                        // User edit/delete buttons for open complaints only
                        if ($is_owner && $status_id === 1):
                            $can_act = true;
                        ?>
                            <div class="mb-3">
                                <a href="index.php?nav=edit-complaint&id=<?php echo $complaint_id; ?>" class="btn btn-warning w-100 btn-sm mb-2">
                                    <i class="fas fa-edit me-1"></i>Edit Complaint
                                </a>
                                <form method="POST" style="display: inline; width: 100%;">
                                    <input type="hidden" name="action" value="user_delete_complaint">
                                    <button type="submit" class="btn btn-danger w-100 btn-sm" onclick="return confirm('Delete this complaint? This action cannot be undone.');">
                                        <i class="fas fa-trash me-1"></i>Delete Complaint
                                    </button>
                                </form>
                            </div>
                        <?php endif;
                        
                        // Staff actions
                        if ((in_array($user_role, [ROLE_STAFF, ROLE_ADMIN]) && $status_id === 1) && !$is_owner):
                            $can_act = true;
                        ?>
                            <form method="POST" class="mb-3">
                                <input type="hidden" name="action" value="mark_in_progress">
                                <button type="submit" class="btn btn-info w-100 btn-sm mb-2">
                                    <i class="fas fa-hourglass-start me-1"></i>Mark In Progress
                                </button>
                            </form>
                        <?php endif;
                        
                        // Staff actions - resolve
                        if ((in_array($user_role, [ROLE_STAFF, ROLE_ADMIN]) && $status_id === 2) && !$is_owner):
                            $can_act = true;
                        ?>
                            <button type="button" class="btn btn-success w-100 btn-sm" data-bs-toggle="modal" data-bs-target="#resolveModal">
                                <i class="fas fa-check-circle me-1"></i>Mark Resolved
                            </button>
                        <?php endif;
                        
                        // Admin actions - closed
                        if ($user_role === ROLE_ADMIN && $status_id === 3 && !$is_owner):
                            $can_act = true;
                        ?>
                            <form method="POST" class="mb-3">
                                <input type="hidden" name="action" value="confirm_resolution">
                                <button type="submit" class="btn btn-success w-100 btn-sm mb-2">
                                    <i class="fas fa-check-double me-1"></i>Confirm & Close
                                </button>
                            </form>
                            <button type="button" class="btn btn-warning w-100 btn-sm" data-bs-toggle="modal" data-bs-target="#reopenModal">
                                <i class="fas fa-redo me-1"></i>Return to Staff
                            </button>
                        <?php endif;
                        
                        if (!$can_act): ?>
                            <div class="alert alert-light text-muted small mb-0">
                                <i class="fas fa-info-circle me-2"></i>
                                No actions available at this time.
                            </div>
                        <?php endif; ?>
                    </div>
                </div>

                <!-- Info Box -->
                <div class="alert alert-light mt-4 border-start border-warning">
                    <small class="fw-600 d-block mb-2" style="color: #dc3545;">Complaint Lifecycle</small>
                    <div class="timeline-compact" style="font-size: 0.85rem;">
                        <div style="margin-bottom: 0.5rem;">
                            <i class="fas fa-circle" style="color: <?php echo $status_id >= 1 ? '#dc3545' : '#ccc'; ?>; margin-right: 0.5rem;"></i>
                            <span>Submitted (Open)</span>
                        </div>
                        <div style="margin-bottom: 0.5rem;">
                            <i class="fas fa-circle" style="color: <?php echo $status_id >= 2 ? '#0dcaf0' : '#ccc'; ?>; margin-right: 0.5rem;"></i>
                            <span>Under Review (In Progress)</span>
                        </div>
                        <div style="margin-bottom: 0.5rem;">
                            <i class="fas fa-circle" style="color: <?php echo $status_id >= 3 ? '#ffc107' : '#ccc'; ?>; margin-right: 0.5rem;"></i>
                            <span>Resolved (Waiting Confirmation)</span>
                        </div>
                        <div>
                            <i class="fas fa-circle" style="color: <?php echo $status_id >= 4 ? '#198754' : '#ccc'; ?>; margin-right: 0.5rem;"></i>
                            <span>Closed (Final)</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Resolve Modal -->
<?php if (in_array($user_role, [ROLE_STAFF, ROLE_ADMIN]) && $status_id === 2): ?>
<div class="modal fade" id="resolveModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header bg-success text-white">
                <h5 class="modal-title"><i class="fas fa-check-circle me-2"></i>Mark Complaint as Resolved</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <form method="POST">
                <div class="modal-body">
                    <p>Provide details about how this complaint was resolved:</p>
                    <input type="hidden" name="action" value="mark_resolved">
                    <div class="mb-3">
                        <label class="form-label fw-600">Resolution Remarks <span class="text-danger">*</span></label>
                        <textarea class="form-control" name="remarks" rows="4" placeholder="Explain how the complaint was resolved..." required></textarea>
                        <small class="text-muted">This message will be visible to the complainant</small>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="submit" class="btn btn-success"><i class="fas fa-check me-1"></i>Mark Resolved</button>
                </div>
            </form>
        </div>
    </div>
</div>
<?php endif; ?>

<!-- Reopen Modal -->
<?php if ($user_role === ROLE_ADMIN && $status_id === 3): ?>
<div class="modal fade" id="reopenModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header bg-warning text-dark">
                <h5 class="modal-title"><i class="fas fa-redo me-2"></i>Return to Staff for Further Review</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <form method="POST">
                <div class="modal-body">
                    <p>This complaint will be returned to staff in progress status for further review.</p>
                    <input type="hidden" name="action" value="reopen">
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="submit" class="btn btn-warning"><i class="fas fa-redo me-1"></i>Return to Staff</button>
                </div>
            </form>
        </div>
    </div>
</div>
<?php endif; ?>

<?php require_once __DIR__ . '/../public/footer.php'; ?>
